{% load static %}
<!doctype html>

<html lang="es" data-layout="vertical" data-layout-width="fluid" data-sidebar="light" data-topbar="brand"
    data-preloader="disable" data-card-layout="border" data-bs-theme="light" data-topbar-image="pattern-2"
    data-sidebar-size="sm" data-layout-position="fixed">
<script>try { sessionStorage.removeItem("defaultAttribute"); sessionStorage.removeItem("data-sidebar-size"); } catch (e) { }</script>

<head>

    <meta charset="utf-8">
    <title>{% block title %} {% endblock title %} | Sistema</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta content="Minimal Admin & Dashboard Template" name="description">
    <meta content="Themesbrand" name="author">

    <!-- App favicon -->
    <link rel="shortcut icon" href="{% static 'images/imagenes_colegio/logoColegio.png' %}">
    <link rel="icon" href="{% static 'images/imagenes_colegio/logoColegio.png' %}">

    {% block css %}
    {% block extra_css %}
    {% endblock extra_css %}

    <!-- Layout config Js -->
    <script src="{% static 'js/layout.js' %}"></script>

    <!-- Bootstrap Css -->
    <link href="{% static 'css/bootstrap.min.css' %}" rel="stylesheet" type="text/css">
    <!-- Icons Css -->
    <link href="{% static 'css/icons.min.css' %}" rel="stylesheet" type="text/css">
    <!-- App Css-->
    <link href="{% static 'css/app.min.css' %}" rel="stylesheet" type="text/css">
    <!-- custom Css-->
    <link href="{% static 'css/custom.css' %}" rel="stylesheet" type="text/css">
    <!-- Cards de Módulos -->
    <link href="{% static 'css/modulo-cards.css' %}" rel="stylesheet" type="text/css">
    <!-- Cards Institucionales -->
    <link href="{% static 'css/cards-institucionales.css' %}" rel="stylesheet" type="text/css">
    <!-- SweetAlert2 (para alertas de timeout) -->
    <link href="{% static 'libs/sweetalert2/sweetalert2.min.css' %}" rel="stylesheet" type="text/css">

    <!-- CSS: RE-ESTRUCTURACIÓN INTEGRAL V-7 (Header & Sidebar) -->
    <style>
        :root {
            --vz-vertical-menu-width: 140px !important;
            --vz-header-height: 70px !important;
        }

        /* 0. RESET & GLOBAL */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
        }

        html,
        body {
            overflow-x: hidden !important;
            width: 100vw !important;
            /* Usar vw para asegurar el viewport total */
            margin: 0 !important;
            padding: 0 !important;
        }

        /* 1. HEADER (BANNER AZUL) - Pegado a la izquierda */
        #page-topbar {
            left: 0 !important;
            top: 0 !important;
            width: 100% !important;
            z-index: 2000 !important;
            padding: 0 !important;
        }

        #page-topbar .layout-width,
        #page-topbar .navbar-header {
            max-width: none !important;
            width: 100% !important;
            padding-left: 0px !important;
            padding-right: 20px !important;
        }

        /* 2. ESCRITORIO (>= 992px) */
        @media (min-width: 992px) {

            /* Menú Vertical Ultra-Compacto */
            .app-menu.navbar-menu {
                width: 140px !important;
                min-width: 140px !important;
                max-width: 140px !important;
                position: fixed;
                left: 0;
                top: 70px !important;
                bottom: 0;
                z-index: 1000;
                border-right: 1px solid #e9ebec;
                padding-top: 0 !important;
            }

            /* Logotipo solo en topbar */
            .navbar-brand-box {
                display: none !important;
            }

            .app-menu .navbar-nav {
                padding-top: 5px !important;
                margin-top: 0 !important;
            }

            .navbar-nav .nav-link {
                padding: 10px 8px !important;
                white-space: nowrap;
                font-size: 12.5px;
                display: flex;
                align-items: center;
            }

            /* 3. CONTENIDO PRINCIPAL - SOLUCIÓN PARA CORTE DERECHO */
            .main-content {
                margin-left: 140px !important;
                margin-top: 70px !important;
                /* calc(100% - 140px) es la fórmula matemática para evitar el desborde */
                width: calc(100% - 140px) !important;
                min-height: calc(100vh - 70px);
                padding: 0 !important;
                overflow-x: hidden !important;
                display: flex;
                flex-direction: column;
            }

            .footer {
                left: 140px !important;
                width: calc(100% - 140px) !important;
                right: 0 !important;
            }

            /* 4. PAGE CONTENT & GRID (CERO GAP) */
            .page-content {
                padding: 1.5rem 1.5rem 1.5rem 0px !important;
                /* Pegado al menú */
                width: 100% !important;
                max-width: 100% !important;
                flex: 1;
            }

            .container-fluid {
                padding-left: 5px !important;
                /* Mínimo aire con el menú */
                padding-right: 15px !important;
                /* Buffer contra corte derecho */
                margin: 0 !important;
                width: 100% !important;
                max-width: none !important;
            }

            /* UI Elements */
            .topnav-hamburger,
            .logo-sm {
                display: none !important;
            }

            .menu-title,
            .nav-link span,
            .logo-lg {
                display: block !important;
                opacity: 1 !important;
                visibility: visible !important;
            }
        }

        /* 3. MÓVIL (< 992px) */
        @media (max-width: 991.98px) {
            #page-topbar {
                left: 0 !important;
                width: 100% !important;
            }

            .main-content {
                margin-left: 0 !important;
                width: 100% !important;
                margin-top: 70px !important;
            }

            .footer {
                left: 0 !important;
                width: 100% !important;
            }

            .topnav-hamburger {
                display: block !important;
            }

            .navbar-brand-box {
                display: block !important;
            }
        }

        /* DEBUG MARKER */
        .page-content::after {
            content: "V.8.1-FIXED";
            position: fixed;
            bottom: 5px;
            right: 5px;
            font-size: 8px;
            color: rgba(0, 0, 0, 0.2);
            pointer-events: none;
            z-index: 9999;
        }
    </style>
    {% endblock css %}

</head>

{% block body %}

<body>
    {% endblock body %}


    <!-- Begin page -->
    <div id="layout-wrapper">

        {% include "partials/sidebar.html" %}

        {% block topbar %}
        {% include "partials/topbar.html" %}
        {% endblock topbar %}

        <div class="main-content">

            <div class="page-content">
                <div class="container-fluid">

                    {% block main_title %}

                    {% endblock main_title %}


                    {% block content %}

                    {% endblock content %}

                </div>
                <!-- container-fluid -->
            </div>
            <!-- End Page-content -->

            {% block footer %}
            {% include "partials/footer.html" %}
            {% endblock footer %}

        </div>
        <!-- end main content-->

    </div>
    <!-- END layout-wrapper -->

    <!-- Modal para Mensajes de Django -->
    {% if messages %}
    <div class="modal fade" id="mensajesModal" tabindex="-1" aria-labelledby="mensajesModalLabel" aria-hidden="true"
        data-bs-backdrop="static" data-bs-keyboard="false">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div
                    class="modal-header {% for message in messages %}{% if message.tags == 'success' %}bg-success{% elif message.tags == 'error' or message.tags == 'danger' %}bg-danger{% elif message.tags == 'warning' %}bg-warning{% elif message.tags == 'info' %}bg-info{% else %}bg-primary{% endif %}{% endfor %} text-white">
                    <h5 class="modal-title" id="mensajesModalLabel">
                        {% for message in messages %}
                        {% if message.tags == 'success' %}
                        <i class="ri-checkbox-circle-line me-2"></i>Éxito
                        {% elif message.tags == 'error' or message.tags == 'danger' %}
                        <i class="ri-error-warning-line me-2"></i>Error
                        {% elif message.tags == 'warning' %}
                        <i class="ri-alert-line me-2"></i>Advertencia
                        {% elif message.tags == 'info' %}
                        <i class="ri-information-line me-2"></i>Información
                        {% else %}
                        <i class="ri-notification-line me-2"></i>Mensaje
                        {% endif %}
                        {% endfor %}
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"
                        aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    {% for message in messages %}
                    <div class="mb-2 {% if not forloop.last %}border-bottom pb-2{% endif %}">
                        <p class="mb-0">{{ message }}</p>
                    </div>
                    {% endfor %}
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cerrar</button>
                </div>
            </div>
        </div>
    </div>
    {% endif %}

    {% block extra_content %}
    {% endblock extra_content %}

    {% block javascript %}

    <!-- JAVASCRIPT -->
    <script src="{% static 'libs/bootstrap/js/bootstrap.bundle.min.js' %}"></script>
    <script src="{% static 'libs/simplebar/simplebar.min.js' %}"></script>
    <script src="{% static 'js/plugins.js' %}"></script>

    {% block extra_js %}
    {% endblock extra_js %}

    <!-- Filtrado dinámico de modelos por marca -->
    <script src="{% static 'js/filtrar-modelos.js' %}"></script>

    <!-- App js -->
    <script src="{% static 'js/app.js' %}"></script>
    <!-- SweetAlert2 (para alertas de timeout) -->
    <script src="{% static 'libs/sweetalert2/sweetalert2.min.js' %}"></script>
    <!-- Session Timeout js -->
    <script src="{% static 'js/session-timeout.js' %}"></script>

    {% endblock javascript %}


    <script>
        // Forzar recalculo de layout al cargar
        window.dispatchEvent(new Event('resize'));

        // Mostrar modal de mensajes automáticamente si existen mensajes
        // EXCEPTO mensajes de login/logout
        {% if messages %}
        document.addEventListener('DOMContentLoaded', function () {
            var modalElement = document.getElementById('mensajesModal');
            if (!modalElement) return;

            // Obtener todos los mensajes del modal
            var mensajes = modalElement.querySelectorAll('.modal-body p');
            var tieneMensajesValidos = false;

            // Textos a filtrar (mensajes de login/logout)
            var textosFiltrados = [
                'inició sesión',
                'cerró sesión',
                'Ha iniciado sesión',
                'Ha cerrado sesión',
                'inicio sesion',
                'cerro sesion'
            ];

            // Verificar si hay mensajes que NO sean de login/logout
            mensajes.forEach(function (mensaje) {
                var textoMensaje = mensaje.textContent.toLowerCase();
                var esMensajeLoginLogout = textosFiltrados.some(function (texto) {
                    return textoMensaje.includes(texto.toLowerCase());
                });

                if (!esMensajeLoginLogout) {
                    tieneMensajesValidos = true;
                } else {
                    // Ocultar el mensaje de login/logout del modal
                    mensaje.closest('.mb-2').style.display = 'none';
                }
            });

            // Solo mostrar el modal si hay mensajes válidos
            if (tieneMensajesValidos) {
                var mensajesModal = new bootstrap.Modal(modalElement);
                mensajesModal.show();
            } else {
                // Si solo hay mensajes de login/logout, ocultar todo el modal
                modalElement.style.display = 'none';
            }
        });
        {% endif %}
    </script>
</body>

</html>