{% extends 'partials/base.html' %}
{% load static %}

{% block title %}{{ titulo }}{% endblock %}

{% block content %}
<div class="page-content">
    <div class="container-fluid">
        <div class="row">
            <div class="col-12">
                <div class="page-title-box d-sm-flex align-items-center justify-content-between">
                    <h4 class="mb-sm-0">{{ titulo }}</h4>
                    <div class="page-title-right">
                        <ol class="breadcrumb m-0">
                            <li class="breadcrumb-item"><a href="{% url 'dashboard_analytics' %}">Dashboard</a></li>
                            <li class="breadcrumb-item"><a href="{% url 'activos:lista_activos' %}">Activos</a></li>
                            <li class="breadcrumb-item active">{{ activo.codigo }}</li>
                        </ol>
                    </div>
                </div>
            </div>
        </div>

        {% if messages %}
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} alert-dismissible fade show" role="alert">
                    {{ message }}
                    <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                </div>
            {% endfor %}
        {% endif %}

        <!-- Información del Activo -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header d-flex align-items-center">
                        <h5 class="card-title mb-0 flex-grow-1">Información del Activo</h5>
                        <div class="d-flex gap-2">
                            {% if perms.activos.add_movimientoactivo %}
                            <a href="{% url 'activos:registrar_movimiento' %}?activo={{ activo.pk }}" class="btn btn-sm btn-primary">
                                <i class="ri-arrow-right-line"></i> Registrar Movimiento
                            </a>
                            {% endif %}
                            {% comment %}
                            Botones de Editar y Eliminar comentados - pueden ser necesarios en el futuro
                            {% if perms.activos.change_activo %}
                            <a href="{% url 'activos:editar_activo' activo.pk %}" class="btn btn-sm btn-secondary">
                                <i class="ri-edit-line"></i> Editar
                            </a>
                            {% endif %}
                            {% if perms.activos.delete_activo %}
                            <a href="{% url 'activos:eliminar_activo' activo.pk %}" class="btn btn-sm btn-danger">
                                <i class="ri-delete-bin-line"></i> Eliminar
                            </a>
                            {% endif %}
                            {% endcomment %}
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th class="ps-0" scope="row">Código:</th>
                                            <td class="text-muted"><strong>{{ activo.codigo }}</strong></td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Nombre:</th>
                                            <td class="text-muted">{{ activo.nombre }}</td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Categoría:</th>
                                            <td class="text-muted">{{ activo.categoria.nombre }}</td>
                                        </tr>
                                        <!-- Los activos son bienes únicos sin unidad de medida -->
                                        <tr>
                                            <th class="ps-0" scope="row">Estado:</th>
                                            <td>
                                                <span class="badge" style="background-color: {{ activo.estado.color }}">
                                                    {{ activo.estado.nombre }}
                                                </span>
                                            </td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <table class="table table-borderless mb-0">
                                    <tbody>
                                        <tr>
                                            <th class="ps-0" scope="row">Marca:</th>
                                            <td class="text-muted">{{ activo.marca|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Modelo:</th>
                                            <td class="text-muted">{{ activo.modelo|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Número de Serie:</th>
                                            <td class="text-muted">{{ activo.numero_serie|default:"-" }}</td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Stock Total:</th>
                                            <td>
                                                {% if stock_total < activo.stock_minimo %}
                                                    <span class="badge bg-danger">{{ stock_total|floatformat:2 }}</span>
                                                {% else %}
                                                    <span class="badge bg-success">{{ stock_total|floatformat:2 }}</span>
                                                {% endif %}
                                            </td>
                                        </tr>
                                        <tr>
                                            <th class="ps-0" scope="row">Stock Mínimo:</th>
                                            <td class="text-muted">{{ activo.stock_minimo|floatformat:2 }}</td>
                                        </tr>
                                    </tbody>
                                </table>
                            </div>
                            {% if activo.descripcion %}
                            <div class="col-12 mt-3">
                                <h6>Descripción:</h6>
                                <p class="text-muted">{{ activo.descripcion }}</p>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Historial de Movimientos -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">
                            <i class="ri-history-line me-2"></i>Historial de Movimientos
                        </h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover table-nowrap align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Fecha</th>
                                        <th>Estado Anterior</th>
                                        <th>Estado Nuevo</th>
                                        <th>Ubicación Destino</th>
                                        <th>Responsable</th>
                                        <th>Usuario Registro</th>
                                        <th>Confirmación</th>
                                        <th>Observaciones</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for mov in movimientos %}
                                    <tr>
                                        <td>
                                            <div>
                                                <strong>{{ mov.fecha_creacion|date:"d/m/Y" }}</strong><br>
                                                <small class="text-muted">{{ mov.fecha_creacion|date:"H:i" }}</small>
                                            </div>
                                        </td>
                                        <td>
                                            {% comment %}
                                            Los movimientos están ordenados por fecha descendente (más reciente primero).
                                            Para el movimiento más reciente (forloop.first), el estado anterior es el estado actual del activo.
                                            Para los demás, el estado anterior es el estado_nuevo del movimiento anterior en la lista.
                                            {% endcomment %}
                                            {% if forloop.first %}
                                                {% comment %}Movimiento más reciente: estado anterior = estado actual del activo{% endcomment %}
                                                {% if activo.estado %}
                                                    <span class="badge bg-secondary">
                                                        {{ activo.estado.nombre }}
                                                    </span>
                                                {% else %}
                                                    <span class="text-muted">-</span>
                                                {% endif %}
                                            {% else %}
                                                {% comment %}Movimientos anteriores: estado anterior = estado_nuevo del movimiento previo{% endcomment %}
                                                {% for mov_previo in movimientos %}
                                                    {% if forloop.counter0 == forloop.parentloop.counter0|add:"-1" %}
                                                        {% if mov_previo.estado_nuevo %}
                                                            <span class="badge bg-secondary">
                                                                {{ mov_previo.estado_nuevo.nombre }}
                                                            </span>
                                                        {% else %}
                                                            <span class="text-muted">-</span>
                                                        {% endif %}
                                                    {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mov.estado_nuevo %}
                                                <span class="badge" style="background-color: {{ mov.estado_nuevo.color }}">
                                                    <i class="ri-arrow-right-line me-1"></i>{{ mov.estado_nuevo.nombre }}
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mov.ubicacion_destino %}
                                                <div>
                                                    <strong class="text-primary">
                                                        <i class="ri-map-pin-2-fill me-1"></i>{{ mov.ubicacion_destino.nombre }}
                                                    </strong>
                                                    {% if mov.ubicacion_destino.descripcion %}
                                                        <br><small class="text-muted">{{ mov.ubicacion_destino.descripcion|truncatechars:40 }}</small>
                                                    {% endif %}
                                                </div>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mov.responsable %}
                                                <small>
                                                    <i class="ri-user-line me-1"></i>
                                                    {{ mov.responsable.get_full_name|default:mov.responsable.username }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            <small class="text-muted">
                                                <i class="ri-user-settings-line me-1"></i>
                                                {{ mov.usuario_registro.get_full_name|default:mov.usuario_registro.username }}
                                            </small>
                                        </td>
                                        <td>
                                            {% if mov.confirmado_con_pin %}
                                                <span class="badge bg-success" data-bs-toggle="tooltip" 
                                                      data-bs-title="Confirmado el {{ mov.fecha_confirmacion_pin|date:'d/m/Y H:i' }}{% if mov.ip_confirmacion %} desde {{ mov.ip_confirmacion }}{% endif %}">
                                                    <i class="ri-checkbox-circle-line me-1"></i>Confirmado
                                                </span>
                                            {% elif mov.responsable %}
                                                <span class="badge bg-warning text-dark">
                                                    <i class="ri-time-line me-1"></i>Pendiente
                                                </span>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if mov.observaciones %}
                                                <small class="text-muted" data-bs-toggle="tooltip" 
                                                       data-bs-title="{{ mov.observaciones }}">
                                                    <i class="ri-file-text-line me-1"></i>
                                                    {{ mov.observaciones|truncatechars:30 }}
                                                </small>
                                            {% else %}
                                                <span class="text-muted">-</span>
                                            {% endif %}
                                        </td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="8" class="text-center py-4">
                                            <p class="text-muted mb-0">
                                                <i class="ri-inbox-line me-2"></i>
                                                No hay movimientos registrados para este activo.
                                            </p>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                        
                        {% if movimientos|length >= 10 %}
                        <div class="mt-3 text-center">
                            <a href="{% url 'activos:lista_movimientos' %}?activo={{ activo.pk }}" class="btn btn-sm btn-outline-primary">
                                <i class="ri-external-link-line me-1"></i>Ver todos los movimientos
                            </a>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>

        <!-- Inventario por Bodega -->
        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="card-title mb-0">Inventario por Bodega</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-nowrap mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Bodega</th>
                                        <th>Cantidad</th>
                                        <th>Lote</th>
                                        <th>Fecha Vencimiento</th>
                                        <th>Última Actualización</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for inv in inventarios %}
                                    <tr>
                                        <td>{{ inv.bodega.nombre }}</td>
                                        <td><strong>{{ inv.cantidad|floatformat:2 }}</strong></td>
                                        <td>{{ inv.lote|default:"-" }}</td>
                                        <td>{{ inv.fecha_vencimiento|date:"d/m/Y"|default:"-" }}</td>
                                        <td>{{ inv.fecha_ultima_actualizacion|date:"d/m/Y H:i" }}</td>
                                    </tr>
                                    {% empty %}
                                    <tr>
                                        <td colspan="5" class="text-center text-muted">No hay inventario registrado para este activo.</td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}
