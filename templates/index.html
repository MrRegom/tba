{% extends 'partials/base.html' %}
{% load static %}
{% block title %} Dashboard {% endblock title %} 

{% block extra_css %}

    <!--popper y jquery -->
    
    <script src="{% static 'lib/jquery/jquery.min.js' %}"></script>
    <script src="{% static 'lib/popper/popper.min.js' %}"></script>

    <!-- jsvectormap css -->
    <link href="{% static 'libs/jsvectormap/jsvectormap.min.css' %}" rel="stylesheet" type="text/css">

    <!-- Dashboard Cards CSS - Separaci√≥n de responsabilidades (SRP) -->
    <link href="{% static 'css/dashboard-cards.css' %}" rel="stylesheet" type="text/css">

{% endblock extra_css %}

{% block main_title %}

                <div class="page-title-box">
                    <div class="row align-items-center gy-3">
                        <div class="col-md">
                            <h3 class="page-title text-capitalize fw-medium fs-3xl"><span class="text-gold">Bienvenido</span> <b class="text-gold">{{ user.get_full_name|default:user.username }}</b> üëã</h3>
                            <p class="mb-0 page-sub-title">Sistema de gesti√≥n de inventario del colegio.</p>
                        </div>
                        <div class="col-md-auto ms-auto">
                        {% block customizer %}
                            {% include "partials/customizer.html" %}
                        {% endblock customizer %}
                        </div>
                    </div>
                </div>
{% endblock main_title %}

{% block content %}     

                    <!-- DASHBOARD OPERATIVO - OPCI√ìN A (4 Cards Principales)        -->
                    <!-- ============================================================ -->
                    <div class="row">
                        <!-- Card 1: Solicitudes Pendientes (CR√çTICO) -->
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <a href="{% url 'solicitudes:lista_solicitudes' %}" class="dashboard-card-link">
                                <div class="card dashboard-stat-card dashboard-stat-warning clickeable">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="dashboard-stat-icon">
                                                <i class="ri-file-warning-line"></i>
                                            </div>
                                            <div class="dashboard-stat-trend {% if solicitudes_change >= 0 %}text-danger{% else %}text-success{% endif %}">
                                                <i class="ph ph-trend-{% if solicitudes_change >= 0 %}up{% else %}down{% endif %} fs-sm align-middle me-1"></i> {% if solicitudes_change >= 0 %}+{% endif %}{{ solicitudes_change|floatformat:1 }}%
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-uppercase fw-bold text-muted text-truncate fs-xs mb-1 dashboard-stat-title">‚ö†Ô∏è Solicitudes Pendientes</p>
                                            <h2 class="fw-bold mb-2 dashboard-stat-value">
                                                <span class="counter-value" data-target="{{ solicitudes_pendientes }}">0</span>
                                            </h2>
                                            <small class="text-muted">Requieren atenci√≥n inmediata</small>
                                        </div>
                                        <div id="solicitudes_pendientes" data-colors='["--tb-warning"]' class="apex-charts" dir="ltr"></div>
                                    </div>
                                </div>
                            </a>
                        </div><!--end col-->
                        
                        <!-- Card 2: √ìrdenes de Compra en Proceso (ALTO) -->
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <a href="{% url 'compras:orden_compra_lista' %}" class="dashboard-card-link">
                                <div class="card dashboard-stat-card dashboard-stat-info clickeable">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="dashboard-stat-icon">
                                                <i class="ri-shopping-cart-line"></i>
                                            </div>
                                            <div class="dashboard-stat-trend {% if ordenes_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                <i class="ph ph-trend-{% if ordenes_change >= 0 %}up{% else %}down{% endif %} fs-sm align-middle me-1"></i> {% if ordenes_change >= 0 %}+{% endif %}{{ ordenes_change|floatformat:1 }}%
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-uppercase fw-bold text-muted text-truncate fs-xs mb-1 dashboard-stat-title">üìã ORDENES COMPRA EN PROCESO</p>
                                            <h2 class="fw-bold mb-2 dashboard-stat-value">
                                                <span class="counter-value" data-target="{{ ordenes_en_proceso }}">0</span>
                                            </h2>
                                            <small class="text-muted">Ordenes pendientes y aprobadas</small>
                                        </div>
                                        <div id="ordenes_en_proceso" data-colors='["--tb-info"]' class="apex-charts" dir="ltr"></div>
                                    </div>
                                </div>
                            </a>
                        </div><!--end col-->
                        
                        <!-- Card 3: Art√≠culos Stock Cr√≠tico (CR√çTICO) -->
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <a href="{% url 'bodega:articulo_lista' %}" class="dashboard-card-link">
                                <div class="card dashboard-stat-card dashboard-stat-danger clickeable">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="dashboard-stat-icon">
                                                <i class="ri-alert-line"></i>
                                            </div>
                                            <div class="dashboard-stat-trend {% if stock_critico_change >= 0 %}text-danger{% else %}text-success{% endif %}">
                                                <i class="ph ph-trend-{% if stock_critico_change >= 0 %}up{% else %}down{% endif %} fs-sm align-middle me-1"></i> {% if stock_critico_change >= 0 %}+{% endif %}{{ stock_critico_change|floatformat:1 }}%
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-uppercase fw-bold text-muted text-truncate fs-xs mb-1 dashboard-stat-title">üö® Stock Cr√≠tico</p>
                                            <h2 class="fw-bold mb-2 dashboard-stat-value">
                                                <span class="counter-value" data-target="{{ articulos_stock_critico }}">0</span>
                                            </h2>
                                            <small class="text-muted">Art√≠culos bajo m√≠nimo</small>
                                        </div>
                                        <div id="articulos_stock_critico" data-colors='["--tb-danger"]' class="apex-charts" dir="ltr"></div>
                                    </div>
                                </div>
                            </a>
                        </div><!--end col-->
                        
                        <!-- Card 4: Solicitudes Entregadas (Mes Actual) -->
                        <div class="col-lg-3 col-md-6 col-sm-6">
                            <a href="{% url 'bodega:entrega_articulo_lista' %}" class="dashboard-card-link">
                                <div class="card dashboard-stat-card dashboard-stat-success clickeable">
                                <div class="card-body">
                                    <div class="d-flex justify-content-between align-items-start mb-3">
                                        <div class="dashboard-stat-icon">
                                                <i class="ri-checkbox-circle-line"></i>
                                            </div>
                                            <div class="dashboard-stat-trend {% if entregas_change >= 0 %}text-success{% else %}text-danger{% endif %}">
                                                <i class="ph ph-trend-{% if entregas_change >= 0 %}up{% else %}down{% endif %} fs-sm align-middle me-1"></i> {% if entregas_change >= 0 %}+{% endif %}{{ entregas_change|floatformat:1 }}%
                                            </div>
                                        </div>
                                        <div>
                                            <p class="text-uppercase fw-bold text-muted text-truncate fs-xs mb-1 dashboard-stat-title">‚úÖ Entregas del Mes</p>
                                            <h2 class="fw-bold mb-2 dashboard-stat-value">
                                                <span class="counter-value" data-target="{{ solicitudes_entregadas_mes }}">0</span>
                                            </h2>
                                            <small class="text-muted">KPI de productividad</small>
                                        </div>
                                        <div id="solicitudes_entregadas_mes" data-colors='["--tb-success"]' class="apex-charts" dir="ltr"></div>
                                    </div>
                                </div>
                            </a>
                        </div><!--end col-->
                    </div><!--end row-->

                    <div class="row">
                        <div class="col-xl-8">
                            <div class="card" id="chart">
                                <div class="card-header border-0 align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Art√≠culos M√°s Utilizados</h4>
                                </div><!-- end card header -->
                                <div class="card-body ps-1">
                                    <div>
                                        <div id="articulos_mas_usados" 
                                             data-colors='["--tb-primary", "--tb-info"]' 
                                             data-nombres='{{ articulos_nombres|safe }}' 
                                             data-cantidades='{{ articulos_cantidades|safe }}' 
                                             class="apex-charts" 
                                             dir="ltr"></div>
                                    </div>
                                </div><!-- end card body -->
                            </div><!-- end card -->
                        </div><!-- end col -->
                        <div class="col-xl-4">
                            <!-- Art√≠culos Stock Bajo -->
                            <div class="card mb-3">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Art√≠culos Stock Bajo</h4>
                                            <div class="flex-shrink-0">
                                        <a href="{% url 'bodega:articulo_lista' %}" class="btn btn-sm btn-subtle-primary">Ver Todos</a>
                                                    </div>
                                </div><!-- end card header -->
                                        <div class="card-body">
                                    <div class="table-responsive table-card">
                                        <table class="table table-hover table-centered align-middle table-nowrap mb-0">
                                            <tbody>
                                                {% for articulo in articulos_stock_bajo %}
                                                <tr>
                                                    <td>
                                                        <div class="d-flex align-items-center">
                                                            <div class="avatar-sm me-2">
                                                            <div class="avatar-title bg-light rounded">
                                                                    <i class="ri-box-3-line text-primary"></i>
                                                        </div>
                                                    </div>
                                                    <div>
                                                                <h6 class="mb-1"><a href="{% url 'bodega:articulo_detalle' articulo.pk %}" class="text-reset">{{ articulo.nombre|truncatewords:3 }}</a></h6>
                                                                <span class="text-muted">{{ articulo.codigo }}</span>
                                                                </div>
                                                            </div>
                                                    </td>
                                                    <td>
                                                        <h6 class="mb-1">
                                                            <span class="badge {% if articulo.stock_actual <= 0 %}bg-danger-subtle text-danger{% elif articulo.stock_actual < articulo.stock_minimo %}bg-warning-subtle text-warning{% else %}bg-success-subtle text-success{% endif %}">
                                                                {{ articulo.stock_actual|floatformat:0 }}
                                                            </span>
                                                        </h6>
                                                        <span class="text-muted">Stock</span>
                                                    </td>
                                                    <td>
                                                        <h6 class="mb-1 text-danger">
                                                            <span class="badge bg-danger-subtle text-danger">
                                                                M√≠n: {{ articulo.stock_minimo|floatformat:0 }}
                                                            </span>
                                                        </h6>
                                                        <span class="text-muted">M√≠nimo</span>
                                                    </td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="3" class="text-center text-muted py-4">
                                                        <i class="ri-checkbox-circle-line fs-2 text-success"></i>
                                                        <p class="mb-0 mt-2">No hay art√≠culos con stock bajo</p>
                                                    </td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                                            </div>
                                </div>
                            </div>
                            
                            <!-- Actividades Recientes (debajo de Art√≠culos Stock Bajo) -->
                            <div class="card actividades-recientes-compacta">
                                <div class="card-header d-flex align-items-center">
                                    <h5 class="card-title flex-grow-1 mb-0">Actividades Recientes</h5>
                                    <div class="flex-shrink-0">
                                        <a href="{% url 'reportes:auditoria_actividades' %}" class="btn btn-subtle-primary btn-sm">Ver M√°s <i class="ph-caret-right align-middle"></i></a>
                                    </div>
                                </div>
                                <div class="card-body px-0">
                                    <div data-simplebar class="px-3 actividades-recientes-container">
                                        <ul class="activity-timeline-2 list-unstyled mb-0 pt-1">
                                            {% for actividad in actividades_recientes %}
                                            <li>
                                                <div class="d-flex align-items-start gap-2">
                                                    <div class="flex-shrink-0">
                                                        <div class="avatar-xs">
                                                            <div class="avatar-title rounded-circle bg-{{ actividad.color }}-subtle text-{{ actividad.color }}">
                                                                <i class="{{ actividad.icono }}"></i>
                                                            </div>
                                                        </div>
                                                    </div>
                                                    <div class="flex-grow-1">
                                                        <h6 class="mb-1 lh-base">{{ actividad.titulo }}</h6>
                                                        <p class="text-muted mb-1">{{ actividad.descripcion }}</p>
                                                        <small class="text-muted">Por {{ actividad.usuario }} - {{ actividad.fecha|date:"d M Y H:i" }}</small>
                                                    </div>
                                                </div>
                                            </li>
                                            {% empty %}
                                            <li>
                                                <p class="text-muted text-center">No hay actividades recientes</p>
                                            </li>
                                            {% endfor %}
                                        </ul>
                                                            </div>
                                </div>
                            </div>
                        </div><!--end col-->
                    </div><!--end row-->

                    <!-- √öltimos Productos y Top Stock -->
                    <div class="row">
                        <div class="col-xl-6">
                                    <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">√öltimos 10 Productos</h4>
                                    <div class="flex-shrink-0">
                                        <a href="{% url 'bodega:articulo_lista' %}" class="btn btn-sm btn-subtle-primary">Ver Todos</a>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-nowrap align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>C√≥digo</th>
                                                    <th>Nombre</th>
                                                    <th>Categor√≠a</th>
                                                    <th>Stock</th>
                                                    <th>Fecha</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for producto in ultimos_productos %}
                                                <tr>
                                                    <td><span class="fw-medium">{{ producto.codigo }}</span></td>
                                                    <td>{{ producto.nombre|truncatewords:5 }}</td>
                                                    <td>{{ producto.categoria.nombre|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge {% if producto.stock_actual > 0 %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %}">
                                                            {{ producto.stock_actual }} {% if producto.unidades_medida.all %}{{ producto.unidades_medida.first.simbolo }}{% endif %}
                                                        </span>
                                                    </td>
                                                    <td>{{ producto.fecha_creacion|date:"d/m/Y" }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No hay productos registrados</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">Top 10 Productos por Stock</h4>
                                    <div class="flex-shrink-0">
                                        <a href="{% url 'bodega:articulo_lista' %}" class="btn btn-sm btn-subtle-primary">Ver Todos</a>
                                    </div>
                                                    </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-nowrap align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>C√≥digo</th>
                                                    <th>Nombre</th>
                                                    <th>Categor√≠a</th>
                                                    <th>Stock</th>
                                                    <th>Unidad</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for producto in productos_top_stock %}
                                                <tr>
                                                    <td><span class="fw-medium">{{ producto.codigo }}</span></td>
                                                    <td>{{ producto.nombre|truncatewords:5 }}</td>
                                                    <td>{{ producto.categoria.nombre|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge bg-primary-subtle text-primary">
                                                            {{ producto.stock_actual }}
                                                        </span>
                                                    </td>
                                                    <td>{% if producto.unidades_medida.all %}{{ producto.unidades_medida.first.simbolo }}{% else %}-{% endif %}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No hay productos registrados</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                    <!-- √öltimas Entregas y Movimientos -->
                    <div class="row mt-3">
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">√öltimas 10 Entregas de Inventario</h4>
                                    <div class="flex-shrink-0">
                                        <a href="{% url 'bodega:entrega_articulo_lista' %}" class="btn btn-sm btn-subtle-primary">Ver Todas</a>
                                            </div>
                                        </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-nowrap align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>N√∫mero</th>
                                                    <th>Tipo</th>
                                                    <th>Estado</th>
                                                    <th>Fecha</th>
                                                    <th>Entregado Por</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for entrega in ultimas_entregas %}
                                                <tr>
                                                    <td><span class="fw-medium">{{ entrega.numero }}</span></td>
                                                    <td>{{ entrega.tipo.nombre|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge {% if entrega.estado.codigo == 'COMPLETADA' %}bg-success-subtle text-success{% elif entrega.estado.codigo == 'PENDIENTE' %}bg-warning-subtle text-warning{% else %}bg-secondary-subtle text-secondary{% endif %}">
                                                            {{ entrega.estado.nombre|default:"-" }}
                                                        </span>
                                                    </td>
                                                    <td>{{ entrega.fecha_entrega|date:"d/m/Y" }}</td>
                                                    <td>{{ entrega.entregado_por.get_full_name|default:entrega.entregado_por.username }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="5" class="text-center text-muted">No hay entregas registradas</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                                                </div>
                                                            </div>
                                                            </div>
                                                        </div>
                        <div class="col-xl-6">
                            <div class="card">
                                <div class="card-header align-items-center d-flex">
                                    <h4 class="card-title mb-0 flex-grow-1">√öltimos 10 Movimientos</h4>
                                    <div class="flex-shrink-0">
                                        <a href="{% url 'bodega:movimiento_lista' %}" class="btn btn-sm btn-subtle-primary">Ver Todos</a>
                                                                </div>
                                                            </div>
                                <div class="card-body">
                                    <div class="table-responsive">
                                        <table class="table table-hover table-nowrap align-middle mb-0">
                                            <thead class="table-light">
                                                <tr>
                                                    <th>Art√≠culo</th>
                                                    <th>Tipo</th>
                                                    <th>Operaci√≥n</th>
                                                    <th>Cantidad</th>
                                                    <th>Usuario</th>
                                                    <th>Fecha</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for movimiento in ultimos_movimientos %}
                                                <tr>
                                                    <td><span class="fw-medium">{{ movimiento.articulo.codigo }}</span></td>
                                                    <td>{{ movimiento.tipo.nombre|default:"-" }}</td>
                                                    <td>
                                                        <span class="badge {% if movimiento.operacion == 'ENTRADA' %}bg-success-subtle text-success{% else %}bg-danger-subtle text-danger{% endif %}">
                                                            {{ movimiento.operacion }}
                                                        </span>
                                                    </td>
                                                    <td>{{ movimiento.cantidad }}</td>
                                                    <td>{{ movimiento.usuario.get_full_name|default:movimiento.usuario.username }}</td>
                                                    <td>{{ movimiento.fecha_creacion|date:"d/m/Y H:i" }}</td>
                                                </tr>
                                                {% empty %}
                                                <tr>
                                                    <td colspan="6" class="text-center text-muted">No hay movimientos registrados</td>
                                                </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    </div>
                                            </div>
                                        </div>
                                        </div>
                                    </div>

{% endblock content %}

{% block extra_js %}

    <!-- apexcharts -->
    <script src="{% static 'libs/apexcharts/apexcharts.min.js' %}"></script>

    <!-- Vector map-->
    <script src="{% static 'libs/jsvectormap/jsvectormap.min.js' %}"></script>
    <script src="{% static 'libs/jsvectormap/maps/world-merc.js' %}"></script>

    <script src="{% static 'libs/list.js/list.min.js' %}"></script>

    <!-- Dashboard init -->
    <script src="{% static 'js/pages/dashboard-ecommerce.init.js' %}"></script>
    
    <!-- Dashboard JavaScript - Separaci√≥n de responsabilidades (SRP) -->
    <!-- Todos los scripts est√°n en archivos separados dentro de static/js/pages/ -->
    <script src="{% static 'js/pages/dashboard-sparklines.init.js' %}"></script>
    <script src="{% static 'js/pages/dashboard-counters.init.js' %}"></script>
    <script src="{% static 'js/pages/dashboard-articulos-mas-usados.init.js' %}"></script>

{% endblock extra_js %}
